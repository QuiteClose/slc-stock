{% extends "base.html" %}
{% block title %}{{ symbol }} — slc-stock{% endblock %}
{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"
        integrity="sha384-T/4KgSWuZEPozpPz7rnnp/5lDSnpY1VPJCojf1S81uTHS1E38qgLfMgVsAeRCWc4"
        crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/luxon@3.5.0/build/global/luxon.min.js"
        integrity="sha384-CU0J6nu6GO5gWB5IqOOhPQsG0LKyjpotF5Gw502R+0zbkzKHjDWc6FKSZsNTJfLX"
        crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1/dist/chartjs-adapter-luxon.umd.min.js"
        integrity="sha384-7cWzHabR6ZyfMWzZgVssYaOQRTccHUWZ0F09AanlF3RAJ/JNyFnIma2JTYIVKEUP"
        crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@0.2.1/dist/chartjs-chart-financial.min.js"
        integrity="sha384-OSSr3vjWsgL3ackkKviJxtoGYpsPeXSwIL4w5W3Ou3TXdA5pdIotbHwQEpFv7x/D"
        crossorigin="anonymous"></script>
{% endblock %}

{% block content %}
<div class="symbol-page">
  <header class="symbol-header">
    <div class="section-heading">
      <h1>{{ symbol }}</h1>
      <span class="api-link" data-url="/api/v1/stock/quote/{{ symbol }}" onclick="copyApiUrl(this)">API</span>
    </div>
    {% if latest %}
    <div class="latest-price">
      <span class="price">${{ "%.2f" | format(latest.close) }}</span>
      <span class="date">{{ latest.date }}</span>
      {% if latest.requested_date and latest.requested_date != latest.date %}
      <span class="fallback-note">(as of {{ latest.date }}, requested {{ latest.requested_date }})</span>
      {% endif %}
    </div>
    {% else %}
    <p class="muted">No cached quote yet.</p>
    {% endif %}
  </header>

  <section class="chart-section">
    <div class="section-heading">
      <h2>Price History</h2>
      <span id="chart-api-link" class="api-link" data-url="/api/v1/stock/history/{{ symbol }}?years=3" onclick="copyApiUrl(this)">API</span>
    </div>
    <div class="chart-controls">
      <div class="range-buttons">
        <button onclick="loadChart(this, '{{ symbol }}', 30)" class="btn-sm">1M</button>
        <button onclick="loadChart(this, '{{ symbol }}', 90)" class="btn-sm">3M</button>
        <button onclick="loadChart(this, '{{ symbol }}', 180)" class="btn-sm">6M</button>
        <button onclick="loadChart(this, '{{ symbol }}', 365)" class="btn-sm">1Y</button>
        <button onclick="loadChart(this, '{{ symbol }}', 1095)" class="btn-sm active">3Y</button>
        <button onclick="loadChart(this, '{{ symbol }}', 3650)" class="btn-sm">All</button>
      </div>
      <div class="chart-type-buttons">
        <button onclick="setChartType('line')" class="btn-sm chart-type-btn active" data-chart-type="line">Line</button>
        <button onclick="setChartType('candlestick')" class="btn-sm chart-type-btn" data-chart-type="candlestick">Candle</button>
      </div>
    </div>
    <div class="chart-container">
      <canvas id="priceChart"></canvas>
    </div>
    <div id="chart-data-holder"
         hx-get="/ui/chart-data/{{ symbol }}?days=1095"
         hx-trigger="load"
         hx-swap="innerHTML"></div>
  </section>

  <section class="quote-lookup">
    <h2>Quote Lookup</h2>
    <form onsubmit="return false;" class="lookup-form">
      <input type="date" id="lookup-date"
             hx-target="#quote-result"
             onchange="lookupQuote(this.value)">
      <div id="quote-result"></div>
    </form>
  </section>

  <div class="symbol-grid">
    <section class="cache-info">
      <div class="section-heading">
        <h2>Cache Info</h2>
        <span class="api-link" data-url="/api/v1/stock/info/{{ symbol }}" onclick="copyApiUrl(this)">API</span>
      </div>
      {% if info %}
      <dl>
        <dt>Total Quotes</dt><dd>{{ info.total_quotes }}</dd>
        <dt>Date Range</dt><dd>{{ info.date_range.earliest or '—' }} → {{ info.date_range.latest or '—' }}</dd>
        <dt>Providers</dt><dd>{{ info.providers | join(', ') }}</dd>
      </dl>
      {% if info.by_provider %}
      <table class="compact">
        <thead><tr><th>Provider</th><th>Count</th><th>Earliest</th><th>Latest</th></tr></thead>
        <tbody>
          {% for prov, data in info.by_provider.items() %}
          <tr>
            <td>{{ prov }}</td>
            <td>{{ data.count }}</td>
            <td>{{ data.earliest or '—' }}</td>
            <td>{{ data.latest or '—' }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% endif %}
      {% else %}
      <p class="muted">No data cached for {{ symbol }}.</p>
      {% endif %}
    </section>

    <section class="prefetch-section">
      <h2>Prefetch</h2>
      <button class="btn"
              hx-post="/ui/prefetch/{{ symbol }}"
              hx-swap="innerHTML"
              hx-target="#prefetch-status">
        Fetch 3yr History
      </button>
      <div id="prefetch-status"></div>
    </section>
  </div>
</div>

<script>
let chartInstance = null;
let activeChartType = 'line';

function loadChart(btn, symbol, days) {
  document.querySelectorAll('.range-buttons .btn-sm').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  var years = Math.max(1, Math.round(days / 365));
  var link = document.getElementById('chart-api-link');
  if (link) link.dataset.url = '/api/v1/stock/history/' + symbol + '?years=' + years;
  htmx.ajax('GET', '/ui/chart-data/' + symbol + '?days=' + days, {target: '#chart-data-holder', swap: 'innerHTML'});
}

function setChartType(type) {
  activeChartType = type;
  document.querySelectorAll('.chart-type-btn').forEach(b => b.classList.remove('active'));
  document.querySelector('.chart-type-btn[data-chart-type="' + type + '"]').classList.add('active');
  tryRenderChart();
}

function lookupQuote(dateStr) {
  if (!dateStr) return;
  htmx.ajax('GET', '/ui/quote/{{ symbol }}/' + encodeURIComponent(dateStr), {target: '#quote-result', swap: 'innerHTML'});
}

function buildLineConfig(labels, closeData) {
  return {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: 'Close',
        data: closeData,
        borderColor: 'rgb(59, 130, 246)',
        backgroundColor: 'rgba(59, 130, 246, 0.1)',
        fill: true,
        tension: 0.1,
        pointRadius: 0,
        borderWidth: 2,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        x: { display: true, ticks: { maxTicksLimit: 8 } },
        y: { display: true, ticks: { callback: v => '$' + v.toFixed(2) } }
      },
      interaction: { intersect: false, mode: 'index' },
    }
  };
}

function buildCandlestickConfig(labels, openData, highData, lowData, closeData) {
  var ohlcData = labels.map(function(dateStr, i) {
    return {
      x: new Date(dateStr).getTime(),
      o: openData[i],
      h: highData[i],
      l: lowData[i],
      c: closeData[i]
    };
  });
  return {
    type: 'candlestick',
    data: {
      datasets: [{
        label: '{{ symbol }}',
        data: ohlcData,
        color: {
          up: 'rgba(16, 185, 129, 1)',
          down: 'rgba(239, 68, 68, 1)',
          unchanged: 'rgba(107, 114, 128, 1)'
        }
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        x: { type: 'time', time: { unit: 'day', tooltipFormat: 'yyyy-MM-dd' }, ticks: { maxTicksLimit: 8 } },
        y: { display: true, ticks: { callback: v => '$' + v.toFixed(2) } }
      },
    }
  };
}

function tryRenderChart() {
  var el = document.getElementById('chart-payload');
  if (!el) return;
  var labels = JSON.parse(el.dataset.labels);
  var closeData = JSON.parse(el.dataset.values);
  var ctx = document.getElementById('priceChart');
  if (!ctx) return;
  if (chartInstance) chartInstance.destroy();

  var config;
  if (activeChartType === 'candlestick' && el.dataset.open) {
    var openData = JSON.parse(el.dataset.open);
    var highData = JSON.parse(el.dataset.high);
    var lowData = JSON.parse(el.dataset.low);
    config = buildCandlestickConfig(labels, openData, highData, lowData, closeData);
  } else {
    config = buildLineConfig(labels, closeData);
  }

  chartInstance = new Chart(ctx, config);
}

document.body.addEventListener('htmx:afterSwap', function(evt) {
  if (evt.detail.target.id === 'chart-data-holder') {
    tryRenderChart();
  }
});
</script>
{% endblock %}
